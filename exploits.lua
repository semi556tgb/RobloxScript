local Exploits = {}

local function StartCFrameSpeedLoop()
    local player = game:GetService("Players").LocalPlayer
    local runService = game:GetService("RunService")
    local input = game:GetService("UserInputService")

    while getgenv().CFrameSpeedEnabled do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local moveDirection = Vector3.zero

            if input:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + hrp.CFrame.LookVector
            end
            if input:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - hrp.CFrame.LookVector
            end
            if input:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - hrp.CFrame.RightVector
            end
            if input:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + hrp.CFrame.RightVector
            end

            if moveDirection.Magnitude > 0 then
                local speed = math.clamp(getgenv().CFrameSpeedValue or 5, 0, 500)
                local delta = runService.Heartbeat:Wait()
                local newPosition = hrp.Position + (moveDirection.Unit * speed * delta)
                -- Fix: Move without forcing rotation, preserving normal camera behavior
                hrp.CFrame = CFrame.new(newPosition, newPosition + hrp.CFrame.LookVector)
            else
                runService.Heartbeat:Wait()
            end
        else
            runService.Heartbeat:Wait()
        end
    end
end

function Exploits.Setup(tab)
    local ExploitSection = tab:AddSection("Movement Exploits", 1)

    ExploitSection:AddToggle({
        text = "Infinite Jump",
        state = false,
        flag = "InfiniteJumpEnabled",
        callback = function(state)
            if state then
                getgenv().InfiniteJump = true
                if not getgenv().InfiniteJumpConnection then
                    getgenv().InfiniteJumpConnection = game:GetService("UserInputService").JumpRequest:Connect(function()
                        if getgenv().InfiniteJump then
                            local humanoid = game:GetService("Players").LocalPlayer.Character and game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if humanoid then
                                humanoid:ChangeState("Jumping")
                            end
                        end
                    end)
                end
            else
                getgenv().InfiniteJump = false
                if getgenv().InfiniteJumpConnection then
                    getgenv().InfiniteJumpConnection:Disconnect()
                    getgenv().InfiniteJumpConnection = nil
                end
            end
        end
    })

    ExploitSection:AddSlider({
        text = "CFrame Speed",
        min = 1,
        max = 500,
        value = 5,
        flag = "CFrameSpeed",
        callback = function(value)
            getgenv().CFrameSpeedValue = value
        end
    })

    ExploitSection:AddToggle({
        text = "Enable CFrame Speed",
        state = false,
        flag = "CFrameSpeedEnabled",
        callback = function(state)
            getgenv().CFrameSpeedEnabled = state
            if state then
                spawn(StartCFrameSpeedLoop)
            end
        end
    })
end

return Exploits
